<!DOCTYPE html>
<html lang="zh-cn">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>gitlab中vue前端项目CI/CD部署笔记 | 指尖魔法屋</title>

    
    <meta name="description" content="持续部署（continuous deployment）是持续交付的下一步，指的是代码通过评审以后，自动部署到生产环境。持续部署的目标是，代码在任何时刻都是可部署的，可以进入生产阶段。">
    <meta name="keywords" content="gitlab">

    
    <meta property="og:title" content="gitlab中vue前端项目CI/CD部署笔记">
    <meta property="og:description" content="持续部署（continuous deployment）是持续交付的下一步，指的是代码通过评审以后，自动部署到生产环境。持续部署的目标是，代码在任何时刻都是可部署的，可以进入生产阶段。">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/post/849_gitlab%E4%B8%ADvue%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AEci_cd%E9%83%A8%E7%BD%B2%E7%AC%94%E8%AE%B0/">
    
    <meta property="og:image" content="http://blog.cdn.thinkmoon.cn/blog/typecho/2020-05-22T06:04:52.png">
    

    
    <link rel="icon" href="/favicon.ico">

    
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/github-markdown.css">
    <link rel="stylesheet" href="/css/custom.css">
</head>
<body>
    
    
    <nav class="top-menu">
        <div class="container">
            <div class="left">
                <a href="/">指尖魔法屋</a>
            </div>
            <ul class="menu">
                <li class="">
                    <a href="/">首页</a>
                </li>
                <li class="">
                    <a href="/categories/">分类</a>
                </li>
                <li class="">
                    <a href="/tags/">标签</a>
                </li>
            </ul>
            <div class="right">
                <a href="/admin" class="admin-link">
                    <span>登录</span>
                </a>
            </div>
        </div>
    </nav>
    

    
    <main>
        
<div class="article-content">
    <div class="markdown-body">
        <h2 id="持续集成">持续集成</h2>
<p>略</p>
<h2 id="gitlab的持续集成">Gitlab的持续集成</h2>
<p>我们可以将整个运行机制，看作一个赏金猎人接任务，执行任务，并完成任务的过程。</p>
<h3 id="gitlab-ci">GitLab-CI</h3>
<p>简单来说，这就是一个任务发布平台。运行在gitlab服务器，监听代码状态变化，并发布对应的任务。</p>
<h3 id="gitlab-runner">GitLab-Runner</h3>
<p>而每个runner就是一位赏金猎人，是任务的执行者。</p>
<p><img src="http://blog.cdn.thinkmoon.cn/blog/typecho/2020-05-22T06:04:52.png" alt="2020-05-22T06:04:52.png"></p>
<h3 id="gitlab-ciyml">.gitlab-ci.yml</h3>
<p>任务的发布者，规定什么时候触发任务，任务的具体内容。</p>
<h2 id="配置流程">配置流程</h2>
<p>经过前面的解释，整个思路就很清晰了。我们需要做的有三件事。</p>
<ol>
<li>
<p>编写<code>.gitlab-ci.yml</code>文件，设置对应的任务</p>
</li>
<li>
<p>部署Runner，激活赏金猎人</p>
</li>
<li>
<p>配置ci，邀请赏金猎人加入系统</p>
</li>
</ol>
<h3 id="部署runner">部署Runner</h3>
<p>这一步需要一个服务器，能run起来赏金猎人。</p>
<h4 id="安装">安装</h4>
<p>请务必安装最新版，不然会出现很多未知的问题</p>
<ol>
<li>下载二进制文件</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Linux x86-64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Linux x86</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-386
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Linux arm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Linux arm64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm64
</span></span></code></pre></div><ol start="2">
<li>授予执行权限</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo chmod +x /usr/local/bin/gitlab-runner
</span></span></code></pre></div><ol start="3">
<li>Create a GitLab CI user:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo useradd --comment <span class="s1">&#39;GitLab Runner&#39;</span> --create-home gitlab-runner --shell /bin/bash
</span></span></code></pre></div><ol start="4">
<li>Install and run as service:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo gitlab-runner install --user<span class="o">=</span>gitlab-runner --working-directory<span class="o">=</span>/home/gitlab-runner
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo gitlab-runner start
</span></span></code></pre></div><h4 id="加入任务系统">加入任务系统</h4>
<p>注册</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo gitlab-runner register
</span></span></code></pre></div><p>然后就是一些简单的配置，配置完成后就将该Runner注册到任务发布平台了，然后就可以接任务了。详细见参考文献【1】</p>
<h4 id="编写gitlab-ciyml任务">编写.gitlab-ci.yml任务</h4>
<p>本机部署版本</p>
<p>.gitlab-ci.yml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">cache</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">node_modules/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">public/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">deployJob</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">deploy </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">npm install </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">npm run build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">rm -rf /home/data/three_miju_shopper_manager_system_front/*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">cp -rf ./dist/* /home/data/three_miju_shopper_manager_system_front/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">sh ./bot.sh ${CI_COMMIT_REF_SLUG} ${CI_COMMIT_SHA:0:8} ${CI_COMMIT_MESSAGE}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">shared_test_machine_runner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">only</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">dev</span><span class="w">
</span></span></span></code></pre></div><p>这个版本具有企业微信群机器人推送功能，需要配置<code>./bot.sh</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#!/usr/bin/env bash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl <span class="s1">&#39;群机器人地址&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>
</span></span><span class="line"><span class="cl">      -H <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>
</span></span><span class="line"><span class="cl">      -d <span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">      {
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#34;msgtype&#34;: &#34;markdown&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#34;markdown&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">          &#34;content&#34;: &#34;商户端代码已更新，分支:&#39;</span><span class="nv">$1</span><span class="s1">&#39; 提交:&#39;</span><span class="nv">$2</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">          更新：&#39;</span><span class="nv">$3</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">          已发布，[点击测试](http://test.shop.gileey.cn)&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        }
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">      }&#39;</span>
</span></span></code></pre></div><p>远程推送版本</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">stages:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  - deploy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cache:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  paths:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - node_modules/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - public/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">deployJob:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  stage: deploy 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  script:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - mkdir -p ~/.ssh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$SSH_PRIVATE_KEY</span><span class="s2">&#34;</span> &gt;&gt; ~/.ssh/id_dsa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - chmod <span class="m">600</span> ~/.ssh/id_dsa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - <span class="nb">echo</span> -e <span class="s2">&#34;Host *\n\tStrictHostKeyChecking no\n\n&#34;</span> &gt; ~/.ssh/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - rsync -avzu --progress ./dist/* root@thinkmoon.cn:/www/wwwroot/3ju.psyannabel.cn/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  tags:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - shared_test_machine_runner
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  only:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - dev
</span></span></code></pre></div><p>该版本在gitlab-runner机器上执行编译等工作，编译完成后使用rsync同步到云服务器，需要配置私钥变量<code>$SSH_PRIVATE_KEY</code></p>
<p><img src="http://blog.cdn.thinkmoon.cn/blog/typecho/2020-05-30T14:20:12.png" alt="2020-05-30T14:20:12.png"></p>
<h2 id="遇到的问题">遇到的问题</h2>
<p>导入自定义组件时一直报错：<code>This dependency was not found:</code></p>
<p>出现背景：由于以前命名组件是&quot;clickImg&quot;,后改成&quot;ClickImg&quot;,由于linux的区分大小写，所以会一直没找到。</p>
<p>解决方案：换个名字？？？</p>
<h2 id="参考文献">参考文献</h2>
<ol>
<li>
<p><a href="https://juejin.im/post/5b03963a51882542821ca56a">前端的gitlab的ci初尝试</a></p>
</li>
<li>
<p><a href="https://docs.gitlab.com/runner/install/linux-manually.html">Install GitLab Runner manually on GNU/Linux</a></p>
</li>
</ol>

    </div>

    
    <ins class="adsbygoogle"
         style="display:block; text-align:center;width: 100%"
         data-ad-client="ca-pub-3208634444966567"
         data-ad-format="fluid"
         data-ad-layout="in-article"
         data-ad-slot="2621880404">
    </ins>
</div>

    </main>

    
    <footer class="footer">
        <div class="container">
            <span>Copyright © 2017-2025 指尖魔法屋. All rights reserved</span>
            <span>POWERED BY thinkBlog · v1.0.0</span>
            <span>网站持续搭建中，感谢关注</span>
            <div class="beian">
                <a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备17055617号</a>
            </div>
        </div>
    </footer>

    
    <script src="/js/thinkblog.js"></script>
</body>
</html>
